# Promtail 配置：采集指定目录 .log 文件 + openim-server / openim-chat 容器日志，推送至 Loki
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # 1. 指定目录下的 .log 文件（如 rust 工程日志）
  - job_name: rust-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: rust-logs
          __path__: /logs/*.log
    pipeline_stages: []

  # 2. openim-server、openim-chat 容器 stdout/stderr 日志（需挂载 Docker 容器目录与 socket）
  - job_name: docker-openim
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # 只保留 openim-server、openim-chat 两个容器
      - source_labels: [__meta_docker_container_name]
        regex: '/(openim-server|openim-chat)'
        action: keep
      # 容器名 -> 标签 container
      - source_labels: [__meta_docker_container_name]
        target_label: container
        regex: '/(.*)'
        replacement: '${1}'
      # 日志流（stdout/stderr）
      - source_labels: [__meta_docker_container_log_stream]
        target_label: stream
    pipeline_stages:
      # 解析 Docker JSON 日志，提取 log 字段为内容
      - docker: {}
