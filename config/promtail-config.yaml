# Promtail 配置：采集指定目录 .log + openim 共享目录日志 + openim 容器日志，推送至 Loki
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # 1. 指定目录下的 .log 文件，提取时间戳和日志级别
  # 路径为容器内：/logs = LOG_COLLECT_DIR（如 /home/wps/opensource/flutter_rust_demo/rust/logs）
  # 支持 Windows 和 Linux：通过环境变量 LOG_COLLECT_DIR 指定日志目录
  # 日志格式：2026-02-10T09:17:59.547349Z  INFO ...
  - job_name: rust-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: rust-logs
          __path__: /logs/rust.log*
    pipeline_stages:
      # 提取时间戳和日志级别
      # 格式1：2026-02-10T09:17:59.547349Z  INFO  src/bin/im_client.rs:36 登录中: +86 17764338283
      # 格式2：2026-02-10T09:17:59.557107Z DEBUG [2d93bec4ec93dbcad55ffc7e007d67a1]  src/im/client/message_handle.rs:178 ...
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}T[\d:\.]+Z)\s+(?P<level>\w+)\s+(?P<message>.*)$'
      # 设置时间戳
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      # 提取日志级别作为标签（用于过滤和查询）
      - labels:
          level: level

  # 2. openim-server、openim-chat 写入共享目录的日志文件（与下方 docker-compose 挂载一致）
  - job_name: openim-file-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: openim-file-logs
          __path__: /openim-logs/**/*.log
    relabel_configs:
      # 从路径提取 server 或 chat 作为 container 标签，便于在 Loki 中区分
      - source_labels: [__path__]
        target_label: container
        regex: '/openim-logs/([^/]+)/.*'
        replacement: '${1}'
    pipeline_stages: []

  # 3. openim-server、openim-chat 容器 stdout/stderr（Docker 日志文件，需挂载 /var/lib/docker/containers）
  - job_name: docker-openim
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["openim-server", "openim-chat"]
    relabel_configs:
      # 使用 Docker 返回的容器日志路径（需宿主机挂载 /var/lib/docker/containers 到 Promtail 同路径）
      - source_labels: [__meta_docker_container_log_path]
        target_label: __path__
      # 容器名 -> 标签 container（去掉前缀 /）
      - source_labels: [__meta_docker_container_name]
        target_label: container
        regex: '/(.*)'
        replacement: '${1}'
    pipeline_stages:
      - docker: {}
