# Promtail 配置：采集指定目录 .log + openim 共享目录日志 + openim 容器日志，推送至 Loki
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # 1. 指定目录下的 .log 文件，每行 JSON：{"timestamp":"...","level":"INFO","fields":{"message":"..."},"target":"..."}
  # 路径为容器内：/logs = LOG_COLLECT_DIR（如 .../rust），实际日志在 rust/logs/ 下，故为 /logs/logs/rust.log*
  - job_name: rust-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: rust-logs
          __path__: /logs/logs/rust.log*
    pipeline_stages:
      - json:
          expressions:
            level: level
            message: fields.message
            target: target
            ts: timestamp
      - timestamp:
          source: ts
          format: RFC3339Nano
      - labels:
          level: level
      - output:
          source: message

  # 2. openim-server、openim-chat 写入共享目录的日志文件（与下方 docker-compose 挂载一致）
  - job_name: openim-file-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: openim-file-logs
          __path__: /openim-logs/**/*.log
    relabel_configs:
      # 从路径提取 server 或 chat 作为 container 标签，便于在 Loki 中区分
      - source_labels: [__path__]
        target_label: container
        regex: '/openim-logs/([^/]+)/.*'
        replacement: '${1}'
    pipeline_stages: []

  # 3. openim-server、openim-chat 容器 stdout/stderr（Docker 日志文件，需挂载 /var/lib/docker/containers）
  - job_name: docker-openim
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["openim-server", "openim-chat"]
    relabel_configs:
      # 使用 Docker 返回的容器日志路径（需宿主机挂载 /var/lib/docker/containers 到 Promtail 同路径）
      - source_labels: [__meta_docker_container_log_path]
        target_label: __path__
      # 容器名 -> 标签 container（去掉前缀 /）
      - source_labels: [__meta_docker_container_name]
        target_label: container
        regex: '/(.*)'
        replacement: '${1}'
    pipeline_stages:
      - docker: {}
